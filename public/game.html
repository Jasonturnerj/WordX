<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
</head>
<body> 
    <h1>Wordx</h1>
    <h2>Type Away</h2>
    <textarea id="textBox" rows="10" cols="50"></textarea><br>
    <div id="timer">60 seconds</div><br>
    <table id="leaderboard-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Score (%)</th>
          <th>Words Per Minute</th>
        </tr>
      </thead>
      <tbody>
        <!-- Leaderboard rows will be inserted here -->
      </tbody>
    </table

    
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
  async function fetchLeaderboard() {
    try {
      const response = await fetch('/leaderboard');
      const leaderboardData = await response.json();
      updateLeaderboard(leaderboardData);
    } catch (error) {
      console.error('Error fetching leaderboard:', error);
    }
  }
    
  function updateLeaderboard(leaderboardData) {
    const leaderboardTable = document.getElementById('leaderboard-table');
    leaderboardTable.innerHTML = ''; // Clear previous data

    leaderboardData.forEach((entry, index) => {
      const row = leaderboardTable.insertRow();
      const rankCell = row.insertCell();
      const usernameCell = row.insertCell();
      const scoreCell = row.insertCell();
      const wpmCell = row.insertCell();

      rankCell.textContent = index + 1;
      usernameCell.textContent = entry.username;
      scoreCell.textContent = parseFloat(entry.percent).toFixed(2) + '%';
      wpmCell.textContent = entry.words_per_minute;
    });
  }

  function startTimer() {
    let timeLeft = 5;
    const timerElement = $('#timer');
    
    const countdown = setInterval(function() {
      timerElement.text(timeLeft + " seconds");
      
      if (timeLeft <= 0) {
        clearInterval(countdown);
        alert('Game over');

        let totalWords = $("#textBox").val().split(" ")

        $.ajax({
          url: "/misspelled_count",
          method: "POST",
          data: { "words": totalWords }
        }).then(function(misspelledWords) {
          let wpm = totalWords - misspelledWords
          let percent = (wpm / totalWords).toFixed(2)

          $.ajax({
            url: "/submit_score",
            method: "POST",
            data: { percent: percent, wpm: wpm }
          }).done(function(data) {
            console.log(data)
          })
        })
      }
      
      timeLeft--;
    }, 1000);
  }

  var timerStarted = false
  $("#textBox").one("input", function() {
    if (!timerStarted) {
      startTimer()
      timerStarted = true
    }
  })

    
  // Fetch leaderboard when the page loads
  fetchLeaderboard()
</script>
</html>
